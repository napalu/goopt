name: Test
permissions:
  contents: read
  pull-requests: write
  statuses: write

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - '**'  # all branches

jobs:
  test:
    strategy:
      matrix:
        go-version: [ 1.18.x, 1.19.x, stable ]
        os: [ ubuntu-latest, macos-latest, windows-latest ]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0
      - name: Debug Current State
        run: |
          echo "Branch: ${{ github.ref }}"
          echo "Commit: $(git rev-parse HEAD)"
          git status
      - name: Setup go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ matrix.go-version }}
      - name: Run Test
        run: |
          go mod tidy
          go test ./... --race
  update-badge:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Setup go
        uses: actions/setup-go@v4
        with:
          go-version: stable
      - name: Generate Coverage
        run: |
          go test -v ./... -covermode=count -coverprofile=coverage.out
          go tool cover -func=coverage.out -o=coverage.out
      - name: Go Coverage Badge
        uses: tj-actions/coverage-badge-go@v1.4
        with:
          filename: coverage.out
      - name: Verify Changed Files
        uses: tj-actions/verify-changed-files@v11
        id: verify-changed-files
        with:
          files: README.md
      - name: Create Pull Request
        if: steps.verify-changed-files.outputs.files_changed == 'true'
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ github.token }}
          commit-message: "chore: Updated coverage badge"
          title: "Update coverage badge"
          body: "Automated PR to update coverage badge"
          branch: update-coverage-badge
          base: main